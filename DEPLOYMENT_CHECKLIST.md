# 部署前安全检查清单

在部署到生产环境之前，请确保完成以下所有检查项。

## 🔐 安全配置

### 1. 生成强随机密钥

- [ ] 生成至少 32 字节的强随机密钥

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

保存生成的密钥，将用于 `AUTH_SECRET`

### 2. 生成密码哈希

- [ ] 为管理员密码生成 SHA-256 哈希

```bash
# 使用在线工具：https://www.sha256generator.com/
# 或使用命令行工具
echo -n "your_password" | sha256sum
```

保存生成的哈希，将用于 `AUTH_PASSWORD_HASH`

### 3. 设置环境变量

- [ ] 使用 `wrangler secret` 命令存储敏感信息

```bash
wrangler secret put AUTH_SECRET
# 输入：上面生成的强随机密钥

wrangler secret put AUTH_PASSWORD_HASH
# 输入：上面生成的密码哈希

wrangler secret put AUTH_USERNAME
# 输入：管理员用户名

wrangler secret put AUTH_ENABLED
# 输入：true（启用认证）
```

### 4. 验证配置文件

- [ ] 检查 `wrangler.jsonc`
  - [ ] 确认没有硬编码的真实密钥
  - [ ] 确认 D1 数据库绑定正确
  - [ ] 确认使用的是示例值

## 🧪 功能测试

### 5. 认证功能测试

- [ ] 测试正确密码登录
- [ ] 测试错误密码登录（应失败）
- [ ] 测试 token 过期（等待 24 小时后应自动登出）
- [ ] 测试"记住我"功能（应有效期 30 天）

### 6. CSRF 保护测试

- [ ] 测试缺少 CSRF token 的请求（应返回 403）
- [ ] 测试有效的 CSRF token（应成功）
- [ ] 测试跨站请求伪造（应被阻止）

### 7. XSS 防护测试

- [ ] 测试注入 `javascript:` 伪协议（应被过滤）
- [ ] 测试注入 `expression()`（应被过滤）
- [ ] 测试注入 `@import`（应被过滤）
- [ ] 测试注入 data URI（非图片类型应被过滤）

### 8. URL 验证测试

- [ ] 测试 HTTP/HTTPS URL（应通过）
- [ ] 测试 `javascript:` URL（应被拒绝）
- [ ] 测试 `data:` URL（应被拒绝）
- [ ] 测试 `file:` URL（应被拒绝）
- [ ] 测试无效 URL 格式（应被拒绝）

### 9. 错误处理测试

- [ ] 测试错误处理不暴露内部信息
- [ ] 测试通用错误消息返回
- [ ] 测试日志不泄露敏感数据

## 📦 代码质量

### 10. 代码构建

- [ ] 运行 `npm install` 安装依赖
- [ ] 运行 `npm run build` 成功构建
- [ ] 没有编译错误或警告

### 11. 代码检查

- [ ] 运行 `npm run lint` 检查代码质量
- [ ] 修复所有 lint 错误

### 12. 类型检查

- [ ] TypeScript 类型检查通过
- [ ] 没有 `any` 类型误用

## 🌐 部署准备

### 13. 数据库初始化

- [ ] 创建 D1 数据库
- [ ] 执行初始化 SQL 脚本
- [ ] 验证表结构正确

### 14. 生产环境配置

- [ ] 确认生产环境域名配置
- [ ] 配置 HTTPS 证书
- [ ] 配置 DNS 解析

### 15. 备份和恢复

- [ ] 设置数据库备份
- [ ] 测试数据导出功能
- [ ] 测试数据导入功能

## 📊 性能优化

### 16. 代码分割

- [ ] 考虑使用动态 import() 减少初始包大小
- [ ] 优化第三方库加载

### 17. 资源优化

- [ ] 图片压缩和优化
- [ ] 启用 CDN 加速

## 🔒 安全加固

### 18. 安全头部

- [ ] 考虑添加 Content Security Policy 头
- [ ] 考虑添加 X-Frame-Options 头
- [ ] 考虑添加 X-Content-Type-Options 头

### 19. CORS 配置

- [ ] 精确配置 CORS 策略
- [ ] 只允许可信域名

### 20. 速率限制

- [ ] 考虑实施 API 速率限制
- [ ] 防止暴力攻击

## 📝 文档

### 21. 更新文档

- [ ] 更新 README.md
- [ ] 更新部署指南
- [ ] 记录安全措施

### 22. 安全文档

- [ ] 阅读并理解 SECURITY_FIXES.md
- [ ] 阅读并理解 AGENTS.md 中的安全部分

## 🚀 部署

### 23. 部署到 Cloudflare Workers

```bash
npm run deploy
```

- [ ] 部署成功
- [ ] 验证访问正常

### 24. 部署后验证

- [ ] 测试所有核心功能
- [ ] 检查日志输出
- [ ] 监控错误率

## 📈 监控和维护

### 25. 设置监控

- [ ] 配置错误监控
- [ ] 配置性能监控
- [ ] 设置告警通知

### 26. 定期维护

- [ ] 定期更新依赖
- [ ] 定期安全审计
- [ ] 定期备份数据

## ⚠️ 重要提醒

1. **密钥管理**: 永远不要将真实的密钥和密码哈希提交到 Git 仓库
2. **密码策略**: 建议管理员使用强密码（至少 12 位，包含大小写字母、数字和特殊字符）
3. **定期更新**: 建议定期更新密码和密钥
4. **日志审查**: 定期审查日志，发现异常活动
5. **安全更新**: 定期检查并应用安全更新

---

**部署日期**: ******\_******
**部署人员**: ******\_******
**复查人员**: ******\_******

**确认**: 所有检查项已完成 ✅

---
